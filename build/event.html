<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>CardByte Event Handler</title>

    <!-- Office.js -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <script>
        /* =========================================================
           CARDBYTE ‚Äì OUTLOOK AUTO-RUN EVENT HANDLER
           ========================================================= */

        const API_URL =
            "https://newqa-enterprise.cardbyte.ai/email-signature/outlook/get-active";

        const AES_KEY = "fnItrY2YfozBqCC2B4XsfqHIvZku3kUOq3DFkbO64kk=";
        const AES_IV = "3YapeNfJDung7TXxeKXn4g==";

        const SIGNATURE_MARKER = "<!-- CARDBYTE_SIGNATURE -->";

        /* ---------------------------------------------------------
           Office Ready
           --------------------------------------------------------- */
        Office.onReady(async () => {
            console.log("‚úÖ CardByte event.html ready");

            try {
                // const mailbox = Office.context.mailbox;
                // const item = mailbox?.item;
                // // if (!item) return;
                // const user = mailbox.userProfile;
                const encryptedEmail = await encryptEmail("sairajesh.korla1272@outlook.com");

                const apiResponse = await fetchActiveSignature(encryptedEmail);
                let updatedCombinedData;

                if (apiResponse.card) {
                    updatedCombinedData =
                        updateFieldsFromCard(apiResponse.card)([...apiResponse.elements]);
                } else {
                    updatedCombinedData = [...apiResponse.elements];
                }

                // const updatedCombinedData = updateFieldsFromCard(apiResponse?.card)([...apiResponse?.elements])
                console.log("üì¶ Signature API response", apiResponse, updatedCombinedData);
                const freshLink = `${apiResponse?.emailSignatureUrl}?v=${Date.now()}`

                const freshLinkForBanner = `${apiResponse?.bannerFileUrl}?v=${Date.now()}`

                const html = generateEmailSignatureHTML(
                    freshLink,
                    updatedCombinedData,
                    freshLinkForBanner,
                    !!apiResponse?.elements?.find(i => i?.key === "banner")?.link
                );

                // const settings = Office.context.roamingSettings;
                // settings.set("defaultSignatureHtml", html)
                // settings.saveAsync((result) => {
                //     if (result.status === Office.AsyncResultStatus.Succeeded) {
                //         console.log("‚úÖ Signature saved");
                //     } else {
                //         console.error("‚ùå Failed to save", result.error);
                //     }
                // });
                // apply(html)
                console.log("üì¶ Signature API response", html);

                // Office.actions.associate("applySignature", window.applySignature);
                console.log("‚úÖ applySignature associated");
            } catch (e) {
                console.error("‚ùå Association failed", e);
                const settings = Office.context.roamingSettings;

                const signatureHtml =
                    settings.get("defaultSignatureHtml") ||
                    `
                        <div style="font-family:Arial;font-size:12px">
                            <strong>${user.displayName}</strong><br/>
                            ${user.emailAddress}<br/>
                            <span style="color:#999">Sent with CardByte</span>
                        </div>
                    `;

                try {
                    await insertAtCursor(item, signatureHtml);
                } catch {
                    await appendSignature(item, signatureHtml);
                }
            }
        });

        /* ---------------------------------------------------------
           Utilities
           --------------------------------------------------------- */
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }
        /* ---------------------------------------------------------
           AES Decryption Helper (Outlook-safe)
           --------------------------------------------------------- */

        function handleAesDecrypt(encryptedText, generatedKey) {
            return new Promise(async (resolve) => {
                try {
                    if (!encryptedText) {
                        resolve("");
                        return;
                    }

                    const keyBuffer = await crypto.subtle.importKey(
                        "raw",
                        base64ToArrayBuffer(generatedKey || AES_KEY),
                        { name: "AES-CBC" },
                        false,
                        ["decrypt"]
                    );

                    const decryptedBuffer = await crypto.subtle.decrypt(
                        {
                            name: "AES-CBC",
                            iv: base64ToArrayBuffer(AES_IV),
                        },
                        keyBuffer,
                        base64ToArrayBuffer(encryptedText)
                    );

                    const decryptedText = new TextDecoder().decode(decryptedBuffer);
                    resolve(decryptedText);

                } catch (error) {
                    console.error("‚ùå AES decrypt failed:", error);
                    // Fail-safe: return original text (never block signature flow)
                    resolve(encryptedText);
                }
            });
        }
        async function encryptEmail(email) {
            const key = await crypto.subtle.importKey(
                "raw",
                base64ToArrayBuffer(AES_KEY),
                { name: "AES-CBC" },
                false,
                ["encrypt"]
            );

            const encrypted = await crypto.subtle.encrypt(
                { name: "AES-CBC", iv: base64ToArrayBuffer(AES_IV) },
                key,
                new TextEncoder().encode(email)
            );

            return btoa(String.fromCharCode(...new Uint8Array(encrypted)));
        }

        async function fetchActiveSignature(encryptedEmail) {
            const res = await fetch(API_URL, {
                method: "GET",
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                    username: encryptedEmail,
                },
            });

            if (!res.ok) {
                throw new Error("Signature API failed: " + res.status);
            }

            // ‚úÖ ALWAYS read as text first
            const rawText = await res.text();

            let encryptedPayload;

            // ‚úÖ If backend returned JSON string
            if (rawText.trim().startsWith("{")) {
                const parsed = JSON.parse(rawText);
                encryptedPayload = parsed?.data;
            }
            // ‚úÖ If backend returned plain encrypted string
            else {
                encryptedPayload = rawText;
            }

            if (!encryptedPayload) {
                throw new Error("No encrypted payload received");
            }

            // ‚úÖ Decrypt
            const decryptedText = await handleAesDecrypt(encryptedPayload);

            // ‚úÖ Parse decrypted JSON
            const parsedData = JSON.parse(decryptedText);

            return parsedData;
        }

        /* ---------------------------------------------------------
           Signature Helpers
           --------------------------------------------------------- */
        function insertAtCursor(item, html) {
            return new Promise((resolve, reject) => {
                item.body.setSelectedDataAsync(
                    html,
                    { coercionType: Office.CoercionType.Html },
                    r => (r.status === "succeeded" ? resolve() : reject(r.error))
                );
            });
        }

        function appendSignature(item, html) {
            return new Promise((resolve, reject) => {
                item.body.getAsync(
                    Office.CoercionType.Html,
                    r => {
                        if (r.status !== "succeeded") {
                            reject(r.error);
                            return;
                        }

                        if (r.value.includes(SIGNATURE_MARKER)) {
                            console.log("üìå Signature already present");
                            resolve();
                            return;
                        }

                        const updated =
                            r.value + "<br><br>" + SIGNATURE_MARKER + html;

                        item.body.setAsync(
                            updated,
                            { coercionType: Office.CoercionType.Html },
                            s => (s.status === "succeeded" ? resolve() : reject(s.error))
                        );
                    }
                );
            });
        }

        const updateFieldsFromCard = (card) => (prevFields) => {
            console.log("sadlkaskdahd", card, prevFields)
            if (!card) return prevFields;
            let youtubeIndex = 0; // for duplicate socials

            return prevFields.map((field) => {
                // ==========================
                // ‚úÖ BASIC TEXT MAPPINGS
                // ==========================
                // ‚úÖ FULL NAME = prefix + firstName + lastName
                if (field.key === "fullName") {
                    const prefix = card.prefix ?? "";
                    const firstName = card.firstName ?? "";
                    const lastName = card.lastName ?? "";

                    const fullName = [prefix, firstName, lastName]
                        .filter(Boolean)
                        .join(" ");

                    return {
                        ...field,
                        value: fullName,
                        // show: Boolean(fullName)   // hide if empty
                    };
                }
                if (field.key === "designation") return { ...field, value: card.designation ?? "" };
                if (field.key === "companyName") return { ...field, value: card.companyName ?? "" };
                if (field.key === "website") return { ...field, value: card.website ?? "" };

                // ==========================
                // ‚úÖ PROFILE PHOTO
                // ==========================
                if (field.key === "profilePhoto") {
                    return {
                        ...field,
                        value: card.profileImage
                            ? `${window.location.origin}/v2/getCardProfileImage/${card.profileImage}`
                            : "",
                        show: field.show,
                    };
                }

                // ==========================
                // ‚úÖ CUSTOM TEXT SAFETY
                // ==========================
                if (field?.key?.startsWith("customText-")) {
                    return field; // DO NOT TOUCH
                }

                // ==========================
                // ‚úÖ EMAIL MAPPING (MULTIPLE)
                // ==========================
                if (field.key?.startsWith("email")) {
                    const index = Number(field.key.replace("email", "")) || 0;
                    const value = card.email?.[index] ?? "";
                    return {
                        ...field,
                        value,
                        // show: Boolean(value && !card.hiddenEmail?.[index])
                    };
                }

                // ==========================
                // ‚úÖ MOBILE MAPPING
                // ==========================
                if (field.key?.startsWith("mobileNumber")) {
                    const index = Number(field.key.replace("mobileNumber", "")) || 0;
                    const mobile = card.mobileNumber?.[index];

                    const value = mobile
                        ? `${mobile.countryCode} ${mobile.number}`
                        : "";

                    return {
                        ...field,
                        value,
                        // show: Boolean(value && !card.hiddenMobile?.[index])
                    };
                }
                if (field.key?.startsWith("fax")) {
                    const index = Number(field.key.replace("fax", "")) || 0;
                    const value = card.fax?.[index] ?? "";

                    return {
                        ...field,
                        value,
                        // show: Boolean(value && !card.hiddenFax?.[index])
                    };
                }

                // ==========================
                // ‚úÖ LANDLINE
                // ==========================
                if (field.key?.startsWith("landlineNumber")) {
                    const index = Number(field.key.replace("landlineNumber", "")) || 0;
                    const value = card.landlineNumber?.[index] ?? "";

                    return {
                        ...field,
                        value,
                        // show: Boolean(value && !card.hiddenLandline?.[index])
                    };
                }

                // ==========================
                // ‚úÖ ADDRESS
                // ==========================
                if (field.key === "addressLine1") return { ...field, value: card.address?.addressLine1 ?? "" };
                if (field.key === "addressLine2") return { ...field, value: card.address?.addressLine2 ?? "" };
                if (field.key === "city") return { ...field, value: card.address?.city ?? "" };
                if (field.key === "state") return { ...field, value: card.address?.state ?? "" };
                if (field.key === "country") return { ...field, value: card.address?.country ?? "" };
                if (field.key === "pincode") return { ...field, value: card.address?.pinCode ?? "" };

                // ==========================
                // ‚úÖ SOCIAL LINKS (MULTI YOUTUBE SAFE)
                // ==========================
                if (field?.name) {
                    const entries = card.social?.filter(
                        soc => soc.socialMediaName === field.name
                    );

                    const social = entries?.[youtubeIndex] || entries?.[0];

                    if (field.name === "youtube") youtubeIndex++;

                    return social
                        ? { ...field, link: social.value }
                        : { ...field, link: "", show: false };
                }

                // ==========================
                // ‚úÖ DEFAULT
                // ==========================
                return field;
            });
        };

        /* ---------------------------------------------------------
           AUTO-RUN ENTRY POINT (MUST BE GLOBAL)
           --------------------------------------------------------- */
        window.applySignature = async function (event) {
            console.log("üöÄ applySignature triggered");

            try {
                const mailbox = Office.context.mailbox;
                const item = mailbox?.item;
                if (!item) return;

                const user = mailbox.userProfile;
                const encryptedEmail = await encryptEmail(user.emailAddress);

                const apiResponse = await fetchActiveSignature(encryptedEmail);
                let updatedCombinedData;
                console.log("üîç apiResponse type:", typeof apiResponse);
                console.log("üîç apiResponse value:", apiResponse);
                console.log("üîç apiResponse?.elements:", apiResponse?.elements);
                console.log("üîç Array.isArray(elements):", Array.isArray(apiResponse?.elements));

                if (apiResponse.card) {
                    updatedCombinedData =
                        updateFieldsFromCard(apiResponse.card)([...apiResponse.elements]);
                } else {
                    console.log("‚ö†Ô∏è No card object, using elements as-is");
                    updatedCombinedData = [...apiResponse.elements];
                }

                console.log("üì¶ Signature API response", apiResponse, updatedCombinedData);
                const freshLink = `${apiResponse?.emailSignatureUrl}?v=${Date.now()}`

                const freshLinkForBanner = `${apiResponse?.bannerFileUrl}?v=${Date.now()}`

                const html = generateEmailSignatureHTML(
                    freshLink,
                    updatedCombinedData,
                    freshLinkForBanner,
                    !!apiResponse?.elements?.find(i => i?.key === "banner")?.link
                );
                const settings = Office.context.roamingSettings;

                const signatureHtml =
                    html || settings.get("defaultSignatureHtml") ||
                    `
                        <div style="font-family:Arial;font-size:12px">
                            <strong>${user.displayName}</strong><br/>
                            ${user.emailAddress}<br/>
                            <span style="color:#999">Sent with CardByte</span>
                        </div>
                    `;

                try {
                    await insertAtCursor(item, signatureHtml);
                } catch {
                    await appendSignature(item, signatureHtml);
                }

                console.log("‚úÖ Signature applied");
            } catch (err) {
                console.error("‚ùå applySignature error", err);
            } finally {
                event.completed();
            }
        };

        function generateEmailSignatureHTML(
            dataURL,
            allFields = [],
            freshLinkForBanner,
            showBanner
        ) {
            const disclaimerField = allFields.find(
                f => f.key === "disclaimer" && f.show
            );

            const normalLinks = allFields
                ?.filter(i => i?.key?.toLowerCase()?.startsWith("social"))
                ?.filter(i => !["teams", "meet", "calendly", "pdf", "url"].includes(i?.name))
                ?.filter(i => i?.show);

            const buttonLinks = allFields
                ?.filter(i => i?.key?.toLowerCase()?.startsWith("social"))
                ?.filter(i => ["teams", "meet", "calendly", "pdf", "url"].includes(i?.name))
                ?.filter(i => i?.show);

            /* ---------- Signature Image (250px) ---------- */
            const signatureImageHTML =
                typeof dataURL === "string" && dataURL.trim()
                    ? `
<tr>
  <td style="padding-bottom:6px;">
    <img
      src="${dataURL}"
      alt="Signature"
      style="
        display:block;
        max-width:250px;
        width:100%;
        height:auto;
        border:1px solid #dcdcdc;
        border-radius:6px;
      "
    />
  </td>
</tr>`
                    : "";

            /* ---------- Social Icons + Buttons ---------- */
            const combinedLinks = [...normalLinks, ...buttonLinks];

            const combinedLinksHTML = combinedLinks.length
                ? `
<tr>
  <td style="padding-top:6px;">
    ${combinedLinks
                    .map(link => {
                        const isButton = ["teams", "meet", "calendly", "pdf", "url"].includes(
                            link?.name
                        );

                        return `
<table
  role="presentation"
  cellpadding="0"
  cellspacing="0"
  border="0"
  style="
    display:inline-table;
    vertical-align:middle;
    margin-right:6px;
    margin-bottom:6px;
  "
>
  <tr>
    <td valign="middle">
      ${isButton
                                ? `
<a
  href="${link?.link}"
  target="_blank"
  style="
    display:inline-block;
    background:#fff;
    padding:6px 14px;
    border-radius:18px;
    border:1px solid #000;
    color:#000;
    font-family:Arial, sans-serif;
    font-size:12px;
    font-weight:500;
    text-decoration:none;
    white-space:nowrap;
  "
>
  ${link?.value
                                    ? `<img src="${link.value}" width="14" style="vertical-align:middle;margin-right:5px;" />`
                                    : ""
                                }
  ${link?.label || link?.name || "Click"}
</a>`
                                : `
<a href="${link?.link}" target="_blank">
  <img
    src="${link.value}"
    width="18"
    height="18"
    style="display:block;border:0;"
  />
</a>`
                            }
    </td>
  </tr>
</table>`;
                    })
                    .join("")}
  </td>
</tr>`
                : "";

            /* ---------- Banner (250px) ---------- */
            const bannerHTML =
                typeof freshLinkForBanner === "string" &&
                    freshLinkForBanner.trim() &&
                    showBanner
                    ? `
<tr>
  <td style="padding-top:6px;">
    <!--[if mso]>
    <table role="presentation" width="250" cellpadding="0" cellspacing="0" border="0">
      <tr><td>
    <![endif]-->

    <table
      role="presentation"
      cellpadding="0"
      cellspacing="0"
      border="0"
      width="100%"
      style="max-width:250px;"
    >
      <tr>
        <td>
          <img
            src="${freshLinkForBanner}"
            alt=""
            width="250"
            height="80"
            style="
              display:block;
              width:100%;
              max-width:250px;
              height:80px;
              border:0;
            "
          />
        </td>
      </tr>
    </table>

    <!--[if mso]></td></tr></table><![endif]-->
  </td>
</tr>`
                    : "";

            /* ---------- Disclaimer ---------- */
            const disclaimerHTML = disclaimerField
                ? `
<tr>
  <td style="padding-top:6px;">
    <p
      style="
        font-size:10px;
        color:#777;
        line-height:1.35;
        margin:0;
        font-family:Arial, sans-serif;
      "
    >
      ${disclaimerField.value.replace(/\n+/g, " ")}
    </p>
  </td>
</tr>`
                : "";

            /* ---------- Final HTML ---------- */
            return `
<table
  cellpadding="0"
  cellspacing="0"
  border="0"
  style="
    font-family:Arial, sans-serif;
    max-width:360px;
    width:100%;
  "
>
  ${signatureImageHTML}
  ${combinedLinksHTML}
  ${bannerHTML}
  ${disclaimerHTML}
</table>
`.trim();
        }

        /* ---------------------------------------------------------
           Manual Debug Trigger
           --------------------------------------------------------- */
        window.testCardByte = () =>
            window.applySignature({ completed: () => console.log("üß™ done") });
    </script>
</head>

<body></body>

</html>