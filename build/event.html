<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>CardByte Outlook Event</title>

  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <script>
    /* =========================================================
       CARDBYTE – OUTLOOK AUTO-RUN EVENT (PRODUCTION)
       ========================================================= */

    let INSERTING = false;
    let STATE = "idle"; // idle | loading | applied

    const SIG_START = "<!-- CARD_BYTE_SIGNATURE_START -->";
    const SIG_END = "<!-- CARD_BYTE_SIGNATURE_END -->";

    /* ---------------------------------------------------------
       Office Ready
       --------------------------------------------------------- */
    Office.onReady(() => {
      console.log("✅ CardByte event.html ready");
      applySignature({ completed: () => { } });
    });

    /* ---------------------------------------------------------
       SERVER CALL (CID READY)
       --------------------------------------------------------- */
    async function fetchSignature(user) {
      const res = await fetch(
        "https://qa-renderer.cardbyte.ai/render-signature-cid",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: user.emailAddress })
        }
      );
      if (!res.ok) throw new Error("Signature API failed");
      return res.json(); // { html, attachments }
    }

    /* ---------------------------------------------------------
       BODY HELPERS
       --------------------------------------------------------- */
    function getBodyHtml(item) {
      return new Promise((resolve, reject) => {
        item.body.getAsync(Office.CoercionType.Html, r =>
          r.status === "succeeded" ? resolve(r.value || "") : reject(r.error)
        );
      });
    }

    function stripExistingSignature(html) {
      return html.replace(
        /<!-- CARD_BYTE_SIGNATURE_START -->[\s\S]*?<!-- CARD_BYTE_SIGNATURE_END -->/gi,
        ""
      ).trim();
    }

    async function replaceBody(item, html) {
      return new Promise((resolve, reject) => {
        item.body.setAsync(
          html,
          { coercionType: Office.CoercionType.Html },
          r => (r.status === "succeeded" ? resolve() : reject(r.error))
        );
      });
    }

    /* ---------------------------------------------------------
       CID ATTACHMENTS
       --------------------------------------------------------- */
    async function attachCidImages(item, attachments = []) {
      for (const img of attachments) {
        await new Promise((resolve, reject) => {
          item.addFileAttachmentFromBase64Async(
            img.base64,
            img.filename,
            { isInline: true, contentId: img.cid },
            r => (r.status === "succeeded" ? resolve() : reject(r.error))
          );
        });
      }
    }

    /* ---------------------------------------------------------
       CURSOR SAFE INSERT (REPLACE MODE)
       --------------------------------------------------------- */
    async function insertSignature(item, html) {
      if (INSERTING) return;
      INSERTING = true;

      try {
        // 1️⃣ Clean existing body
        const current = await getBodyHtml(item);
        const cleaned = stripExistingSignature(current);
        if (cleaned !== current) {
          await replaceBody(item, cleaned);
        }

        // 2️⃣ Focus editor
        item.body.focus();

        // 3️⃣ Insert anchor
        await new Promise((resolve, reject) => {
          item.body.setSelectedDataAsync(
            `<br/>${SIG_START}<span id="cb-anchor"></span>${SIG_END}`,
            { coercionType: Office.CoercionType.Html },
            r => (r.status === "succeeded" ? resolve() : reject(r.error))
          );
        });

        // 4️⃣ Replace anchor with final HTML
        await new Promise((resolve, reject) => {
          item.body.getAsync(Office.CoercionType.Html, r => {
            if (r.status !== "succeeded") return reject(r.error);
            const updated = r.value.replace(
              `<span id="cb-anchor"></span>`,
              html
            );
            item.body.setAsync(
              updated,
              { coercionType: Office.CoercionType.Html },
              rr => (rr.status === "succeeded" ? resolve() : reject(rr.error))
            );
          });
        });

      } finally {
        INSERTING = false;
      }
    }

    /* ---------------------------------------------------------
       AUTO-RUN ENTRY POINT
       --------------------------------------------------------- */
    async function applySignature(event = { completed: () => { } }) {
      if (STATE !== "idle") {
        event.completed();
        return;
      }

      const mailbox = Office.context.mailbox;
      const item = mailbox?.item;
      const user = mailbox?.userProfile;

      if (!item) {
        event.completed();
        return;
      }

      try {
        STATE = "loading";

        // 1️⃣ Get server-rendered payload
        const payload = await fetchSignature(user);
        if (!payload?.html) throw new Error("Invalid signature payload");
        console.log("✅ Signature payload fetched", payload);
        // 2️⃣ Attach CID images
        await attachCidImages(item, payload.attachments);

        // 3️⃣ Insert HTML
        await insertSignature(item, payload.html);

        STATE = "applied";
        console.log("✅ Signature applied");

      } catch (err) {
        console.error("❌ Signature failed", err);
        STATE = "idle";
      } finally {
        event.completed();
      }
    }

    window.applySignature = applySignature;
  </script>
</head>

<body></body>

</html>