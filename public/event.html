<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        console.log("=== CARDBYTE AUTOLOADER LOADED ===", new Date().toISOString());

        let autoInsertEnabled = true;
        let insertedMessages = new Set(); // Track inserted messages

        Office.onReady(() => {
            console.log("‚úÖ Office.js ready");

            // Register function for manual button
            if (Office.actions) {
                Office.actions.associate("insertSignature", insertSignatureManual);
                console.log("‚úÖ Manual insert function registered");
            }

            // Setup auto-insertion
            setupAutoInsertion();

            // Check immediately if we're already in a compose window
            checkAndAutoInsert();
        });

        // Manual insert from button
        function insertSignatureManual(event) {
            console.log("üîò Manual insert triggered");
            insertSignature()
                .then(() => {
                    if (event && event.completed) event.completed();
                })
                .catch(error => {
                    console.error("Manual insert failed:", error);
                    if (event && event.completed) event.completed();
                });
        }

        function setupAutoInsertion() {
            try {
                // Method 1: Listen for item changes (most reliable)
                Office.context.mailbox.addHandlerAsync(
                    Office.EventType.ItemChanged,
                    handleItemChanged,
                    function (result) {
                        console.log("ItemChanged handler registered:",
                            result.status === Office.AsyncResultStatus.Succeeded ? "‚úÖ" : "‚ùå");
                    }
                );

                // Method 2: Listen for appointment time changed (also triggers for emails)
                Office.context.mailbox.addHandlerAsync(
                    Office.EventType.AppointmentTimeChanged,
                    handleItemChanged,
                    function (result) {
                        console.log("AppointmentTimeChanged handler registered:",
                            result.status === Office.AsyncResultStatus.Succeeded ? "‚úÖ" : "‚ùå");
                    }
                );

                console.log("‚úÖ Auto-insertion handlers registered");

            } catch (error) {
                console.error("Failed to setup auto-insertion:", error);
            }
        }

        function handleItemChanged(eventArgs) {
            console.log("üîÑ Item changed event triggered");
            // Delay to ensure compose window is ready
            setTimeout(checkAndAutoInsert, 1000);
        }

        async function checkAndAutoInsert() {
            if (!autoInsertEnabled) {
                console.log("‚è∏Ô∏è Auto-insert disabled");
                return;
            }

            const item = Office.context.mailbox.item;
            if (!item || item.itemType !== Office.MailboxEnums.ItemType.Message) {
                return;
            }

            // Generate unique ID for this message
            const messageId = await getMessageId(item);

            // Check if we already inserted signature in this message
            if (insertedMessages.has(messageId)) {
                console.log("üìå Already inserted in this message");
                return;
            }

            // Check if this is a new message
            const isNewMessage = await checkIfNewMessage(item);
            if (!isNewMessage) {
                console.log("‚è≠Ô∏è Not a new message, skipping");
                return;
            }

            console.log("üéØ New message detected, auto-inserting signature");
            await insertSignature();
            insertedMessages.add(messageId);
        }

        async function getMessageId(item) {
            try {
                // Try to get conversation ID or create a timestamp-based ID
                const conversationId = item.conversationId;
                if (conversationId) return conversationId;

                // Fallback: timestamp + random
                return Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            } catch (error) {
                return 'unknown-' + Date.now();
            }
        }

        async function checkIfNewMessage(item) {
            try {
                // Get subject and body
                const subject = item.subject || "";
                const bodyResult = await new Promise(resolve => {
                    item.body.getAsync(Office.CoercionType.Html, resolve);
                });

                if (bodyResult.status !== Office.AsyncResultStatus.Succeeded) {
                    return false;
                }

                const body = bodyResult.value || "";

                // Check for reply/forward indicators
                const isReplyOrForward =
                    subject.toLowerCase().includes("re:") ||
                    subject.toLowerCase().includes("fw:") ||
                    subject.toLowerCase().includes("fwd:") ||
                    body.includes("From:") ||
                    body.includes("Sent:") ||
                    body.includes("To:") ||
                    body.includes("Subject:") ||
                    body.includes("Original Message") ||
                    body.length > 500; // Long bodies are likely replies

                return !isReplyOrForward;

            } catch (error) {
                console.error("Error checking message:", error);
                return false;
            }
        }

        async function insertSignature() {
            console.log("üìù Inserting signature...");

            try {
                const item = Office.context.mailbox.item;
                const signature = await getSignature();

                // Method 1: Try to insert at cursor
                await insertAtCursor(item, signature);

                console.log("‚úÖ Signature inserted successfully");
                return true;

            } catch (error) {
                console.error("Failed to insert signature:", error);
                return false;
            }
        }

        async function getSignature() {
            // Try to get from localStorage first (set by taskpane)
            try {
                const saved = localStorage.getItem('cardbyte_signature');
                if (saved) {
                    console.log("üìã Using saved signature from localStorage");
                    return saved;
                }
            } catch (error) {
                console.warn("Could not access localStorage:", error);
            }

            // Default signature
            return `
                <div style="font-family: Arial, sans-serif; font-size: 12px; color: #333; margin-top: 20px; padding-top: 20px; border-top: 2px solid #0066cc;">
                    <strong style="color: #0066cc; font-size: 14px;">CardByte Signature</strong><br/>
                    <span style="color: #666;">Auto-inserted signature</span><br/><br/>
                    üìß <a href="mailto:support@cardbyte.ai" style="color: #0066cc; text-decoration: none;">support@cardbyte.ai</a><br/>
                    üåê <a href="https://cardbyte.ai" style="color: #0066cc; text-decoration: none;">cardbyte.ai</a>
                    <div style="font-size: 10px; color: #999; margin-top: 10px;">
                        Sent with CardByte Signature Manager
                    </div>
                </div>
            `;
        }

        async function insertAtCursor(item, signature) {
            return new Promise((resolve, reject) => {
                item.body.setSelectedDataAsync(
                    signature,
                    { coercionType: Office.CoercionType.Html },
                    function (result) {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve();
                        } else {
                            // Fallback to append
                            appendToBody(item, signature).then(resolve).catch(reject);
                        }
                    }
                );
            });
        }

        async function appendToBody(item, signature) {
            return new Promise((resolve, reject) => {
                item.body.getAsync(
                    Office.CoercionType.Html,
                    function (result) {
                        if (result.status !== Office.AsyncResultStatus.Succeeded) {
                            reject(result.error);
                            return;
                        }

                        const currentBody = result.value || "";
                        const newBody = currentBody + "<br><br>" + signature;

                        item.body.setAsync(
                            newBody,
                            { coercionType: Office.CoercionType.Html },
                            function (setResult) {
                                if (setResult.status === Office.AsyncResultStatus.Succeeded) {
                                    resolve();
                                } else {
                                    reject(setResult.error);
                                }
                            }
                        );
                    }
                );
            });
        }

        // Enable/disable auto-insert from taskpane
        window.cardByteAutoInsert = {
            enable: function () { autoInsertEnabled = true; console.log("‚úÖ Auto-insert enabled"); },
            disable: function () { autoInsertEnabled = false; console.log("‚è∏Ô∏è Auto-insert disabled"); },
            test: function () { checkAndAutoInsert(); }
        };

        console.log("=== AUTOLOADER INITIALIZED ===");
    </script>
</head>

<body>
    <!-- Empty body -->
</body>

</html>