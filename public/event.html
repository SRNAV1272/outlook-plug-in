<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>CardByte Event Handler</title>

  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <script>
    /* =========================================================
       CARDBYTE ‚Äì OUTLOOK AUTO-RUN EVENT HANDLER
       ========================================================= */
    let SIGNATURE_STATE = "idle"; // idle | loading | applied

    const SIGNATURE_SPACER = `
            <br>
            <div style="min-height:50px;">&nbsp;</div>
            <br>
        `;

    const SIGNATURE_MARKER = "<!-- CARDBYTE_SIGNATURE -->";

    /* ---------------------------------------------------------
       Office Ready
       --------------------------------------------------------- */

    Office.onReady(() => {
      window.applySignature({
        completed: () => console.log("‚úÖ Office.onReady completed")
      });
    });

    async function renderSignatureOnServer(user) {
      try {

        const res = await fetch("https://qa-renderer.cardbyte.ai/render-signature", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email: user.emailAddress })
        });
        if (!res.ok) {
          throw new Error("Node renderer failed");
        }
        const data = await res?.json()
        return data; // optional
      } catch (e) {
        console.error("error", e)
        return null;
      }
    }

    /* ---------------------------------------------------------
       Signature Helpers
       --------------------------------------------------------- */

    function stabilizeSelection(item) {
      // return new Promise(resolve => {
      //   item.body.getSelectedDataAsync(
      //     Office.CoercionType.Html,
      //     () => resolve()
      //   );
      // });
      return Promise.resolve();
    }

    // function insertAtCursor(item, html) {
    //   return new Promise((resolve, reject) => {
    //     item.body.setAsync(
    //       html,
    //       { coercionType: Office.CoercionType.Html },
    //       r => (r.status === "succeeded" ? resolve() : reject(r.error))
    //     );
    //   });
    // }

    function insertAtCursor(item, html) {
      return new Promise((resolve, reject) => {
        html = `
        <table cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;border-spacing:0;margin:0 0;padding:0 0;font-family:Arial,Helvetica,sans-serif;background-color:#ffffff"><tr
            style="
                padding:0px;
                border:none;
                margin:0;
            "
            ><td
                
                rowspan="2"
                width="150"
                height=""
                style="
                    padding:2px;
                    vertical-align:middle;
                    text-align:center;
                    border:none;
                    margin:0 0;;
                "
            >
                            <img
                                src="
        data:image/gif;base64,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
    "
                                width="80"
                                height="80"
                                style="display:inline-block;border:2px solid #d1d5db;border-radius:8px;text-align:center;"
                            /></td><td
                
                
                width=""
                height=""
                style="
                    padding:0px;
                    vertical-align:bottom;
                    text-align:left;
                    border:none;
                    margin:0 0;;
                "
            ><p style="font-family:Arial, Helvetica, sans-serif;font-size:16px;color:#2d6cd2;line-height:1;font-weight:bold;margin:0;padding:0;padding-right:5px;padding-left:5px;text-align:left">
                            John A. Smith
                        </p></td></tr><tr
            style="
                padding:0px;
                border:none;
                margin:0;
            "
            ><td
                
                
                width=""
                height=""
                style="
                    padding:0px;
                    vertical-align:top;
                    text-align:left;
                    border:none;
                    margin:0 0;;
                "
            ><p style="font-family:Arial, Helvetica, sans-serif;font-size:14px;color:#134181;line-height:1;font-weight:bold;margin:0;padding:0;padding-right:5px;padding-left:5px;text-align:left">
                            Senior Marketing Manager
                        </p></td></tr><tr
            style="
                padding:0px;
                border:none;
                margin:0;
            "
            ><td
                
                
                width="100"
                height=""
                style="
                    padding:0px;
                    vertical-align:top;
                    text-align:left;
                    border:none;
                    margin:0 0;;
                "
            >
                                    <table cellpadding="0" cellspacing="0" border="0"
                                        style="border-collapse:collapse;margin:0 0;">
                                        <tr>
                                
                                        <td style="margin:0;padding:0;padding-right:6px;padding-left:6px;vertical-align:middle;white-space:wrap;word-wrap:break-word;">
                                            <span style="font-family:Rockwell, Courier Bold, Courier, Georgia, Times, Times New Roman, serif;font-size:13px;color:#ce2c2c;font-weight:bold;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                                Tel:
                                            </span>
                                        </td>
                                    
                                    <td style="margin:0;padding:0;padding-right:10px;vertical-align:middle;word-wrap:break-word;">
                                        <span style="font-family:Rockwell, Courier Bold, Courier, Georgia, Times, Times New Roman, serif;font-size:13px;color:#ce2c2c;font-weight:bold;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                            +91 7024899020
                                        </span>
                                    </td>
                                
                                        </tr>
                                    </table>
                                </td><td
                
                
                width=""
                height=""
                style="
                    padding:0px;
                    vertical-align:top;
                    text-align:left;
                    border:none;
                    margin:0 0;;
                "
            >
                                    <table cellpadding="0" cellspacing="0" border="0"
                                        style="border-collapse:collapse;margin:0 0;">
                                        <tr>
                                
                                        <td style="margin:0;padding:0;padding-right:6px;padding-left:6px;vertical-align:middle;white-space:wrap;word-wrap:break-word;">
                                            <span style="font-family:Arial, Helvetica, sans-serif;font-size:13px;color:#000000;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                                Mobile:
                                            </span>
                                        </td>
                                    
                                    <td style="margin:0;padding:0;padding-right:10px;vertical-align:middle;word-wrap:break-word;">
                                        <span style="font-family:Arial, Helvetica, sans-serif;font-size:13px;color:#000000;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                            +91 7024899020
                                        </span>
                                    </td>
                                
                                        </tr>
                                    </table>
                                </td></tr><tr
            style="
                padding:0px;
                border:none;
                margin:0;
            "
            ><td
                
                
                width=""
                height=""
                style="
                    padding:0px;
                    vertical-align:top;
                    text-align:left;
                    border:none;
                    margin:0 0;;
                "
            >
                                    <table cellpadding="0" cellspacing="0" border="0"
                                        style="border-collapse:collapse;margin:0 0;">
                                        <tr>
                                
                                        <td style="margin:0;padding:0;padding-right:6px;padding-left:6px;vertical-align:middle;white-space:wrap;word-wrap:break-word;">
                                            <span style="font-family:Arial, Helvetica, sans-serif;font-size:13px;color:#000000;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                                Web:
                                            </span>
                                        </td>
                                    
                                    <td style="margin:0;padding:0;padding-right:10px;vertical-align:middle;word-wrap:break-word;">
                                        <span style="font-family:Arial, Helvetica, sans-serif;font-size:13px;color:#000000;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                            www.acme.com
                                        </span>
                                    </td>
                                
                                        </tr>
                                    </table>
                                </td><td
                colspan="2"
                
                width=""
                height=""
                style="
                    padding:0px;
                    vertical-align:top;
                    text-align:left;
                    border:none;
                    margin:0 0;;
                "
            ><table cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;margin:0;padding:0;"><tr></tr></table>
                                    <table cellpadding="0" cellspacing="0" border="0"
                                        style="border-collapse:collapse;margin:0 0;">
                                        <tr>
                                
                                        <td style="margin:0;padding:0;padding-right:6px;padding-left:6px;vertical-align:middle;white-space:wrap;word-wrap:break-word;">
                                            <span style="font-family:Arial, Helvetica, sans-serif;font-size:13px;color:#000000;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                                Email:
                                            </span>
                                        </td>
                                    
                                    <td style="margin:0;padding:0;padding-right:10px;vertical-align:middle;word-wrap:break-word;">
                                        <span style="font-family:Arial, Helvetica, sans-serif;font-size:13px;color:#000000;line-height:1.3;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;">
                                            john.smith@acme.com
                                        </span>
                                    </td>
                                
                                        </tr>
                                    </table>
                                </td></tr><tr
            style="
                padding:0px;
                border:none;
                margin:0;
            "
            ><td
                colspan="2"
                
                width="300"
                height=""
                style="
                    padding:2px;
                    vertical-align:top;
                    text-align:left;
                    border:none;
                    margin:0 0;;
                "
            ><p style="font-family:Arial, Helvetica, sans-serif;font-size:11px;color:#666;line-height:1.4;font-style:italic;margin:0;padding:0;margin:0;font-style:italic">
                            This email and any attachments are confidential and may be privileged. If you are not the intended recipient, please delete it and notify us immediately.
                        </p></td></tr><tr
            style="
                padding:0px;
                border:none;
                margin:0;
            "
            ></tr></table>
        `

        const wrappedHtml = wrapForOutlook(html);

        // Check if content exceeds safe limit (usually ~10KB)
        const MAX_CHUNK_SIZE = 8000; // Conservative limit
        const htmlString = wrappedHtml.toString();

        if (htmlString.length > MAX_CHUNK_SIZE) {
          console.warn(`HTML size ${htmlString.length} bytes exceeds safe limit. Using chunked approach.`);
          insertInChunks(item, htmlString, resolve, reject);
          return;
        }

        // ‚úÖ Modern Outlook (Mailbox ‚â•1.10)
        if (item.body.appendOnSendAsync) {
          item.body.appendOnSendAsync(
            wrappedHtml,
            { coercionType: Office.CoercionType.Html },
            (result) => {
              if (result.status === Office.AsyncResultStatus.Succeeded) {
                console.log("‚úÖ Signature appended using appendOnSendAsync");
                resolve();
              } else {
                console.error("appendOnSendAsync failed:", result.error);
                reject(result.error);
              }
            }
          );
          return;
        }

        // ‚úÖ Legacy fallback (insert at cursor)
        if (item.body.setSelectedDataAsync) {
          item.body.setSelectedDataAsync(
            wrappedHtml,
            { coercionType: Office.CoercionType.Html },
            (result) => {
              if (result.status === Office.AsyncResultStatus.Succeeded) {
                console.log("‚úÖ Signature inserted using setSelectedDataAsync");
                resolve();
              } else {
                console.error("setSelectedDataAsync failed:", result.error);
                reject(result.error);
              }
            }
          );
          return;
        }

        // üß© Absolute fallback for old clients
        item.body.setAsync(
          wrappedHtml,
          { coercionType: Office.CoercionType.Html },
          (result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              console.log("‚úÖ Signature set using setAsync");
              resolve();
            } else {
              console.error("setAsync failed:", result.error);
              reject(result.error);
            }
          }
        );
      });
    }
    function insertInChunks(item, htmlString, resolve, reject) {
      const CHUNK_SIZE = 7000; // Smaller chunks for safety

      // Split HTML into smaller chunks at reasonable breakpoints
      const chunks = [];
      let start = 0;

      while (start < htmlString.length) {
        // Try to break at tag boundaries for cleaner insertion
        let end = Math.min(start + CHUNK_SIZE, htmlString.length);

        // Look for a closing tag to break at
        if (end < htmlString.length) {
          const slice = htmlString.substring(end - 50, end + 50);
          const tagMatch = slice.match(/<\/[^>]+>/);
          if (tagMatch) {
            const matchIndex = slice.indexOf(tagMatch[0]);
            end = end - 50 + matchIndex + tagMatch[0].length;
          }
        }

        chunks.push(htmlString.substring(start, end));
        start = end;
      }

      // Insert chunks sequentially
      let currentChunk = 0;

      function insertNextChunk() {
        if (currentChunk >= chunks.length) {
          console.log("‚úÖ All chunks inserted successfully");
          resolve();
          return;
        }

        const chunk = chunks[currentChunk];
        console.log(`Inserting chunk ${currentChunk + 1}/${chunks.length} (${chunk.length} bytes)`);

        item.body.setSelectedDataAsync(
          chunk,
          { coercionType: Office.CoercionType.Html },
          (result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              currentChunk++;

              // Small delay between chunks to prevent race conditions
              setTimeout(insertNextChunk, 100);
            } else {
              console.error(`Failed to insert chunk ${currentChunk + 1}:`, result.error);
              reject(result.error);
            }
          }
        );
      }

      insertNextChunk();
    }

    function wrapForOutlook(innerHtml) {
      return `
          <div style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; mso-line-height-rule: exactly;">
            <table cellpadding="0" cellspacing="0" border="0" style="font-family: inherit; font-size: inherit; color: inherit;">
              <tbody>
                <tr>
                  <td style="padding: 0; margin: 0;">
                    ${innerHtml}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
    }

    async function insertSignatureWithoutCursorError(item, signatureHtml) {
      try {
        // prevent parallel insertions
        if (window.__INSERTING_SIGNATURE__) return;
        window.__INSERTING_SIGNATURE__ = true;
        // 1. stabilize selection
        await stabilizeSelection(item);

        // 3Ô∏è‚É£ LATE cleanup (critical)
        // await ensureNoOutlookSignature(item);

        // 2. insert immediately
        await insertAtCursor(
          item,
          `<br/><br/><!-- CARD_BYTE_SIGNATURE_START -->${signatureHtml}<!-- CARD_BYTE_SIGNATURE_END -->`
        );

      } finally {
        window.__INSERTING_SIGNATURE__ = false;
      }
    }

    /* ---------------------------------------------------------
       AUTO-RUN ENTRY POINT (MUST BE GLOBAL)
       --------------------------------------------------------- */

    /* ---------------------------------------------------------
    BODY READ + DETECTION HELPERS
    --------------------------------------------------------- */

    function getBodyHtml(item) {
      return new Promise((resolve, reject) => {
        item.body.getAsync(Office.CoercionType.Html, r => {
          if (r.status === "succeeded") resolve(r.value || "");
          else reject(r.error);
        });
      });
    }

    function hasCardByteSignature(html) {
      return (
        html.includes("CARD_BYTE_SIGNATURE_START") ||
        html.includes("CARDBYTE_SIGNATURE")
      );
    }

    function looksLikeOutlookDefaultSignature(html) {
      return (
        /class="?MsoNormal"?/i.test(html) ||
        /<meta name="Generator" content="Microsoft Outlook"/i.test(html) ||
        /--<br\s*\/?>/i.test(html) ||
        /Sent from (my )?iPhone/i.test(html)
      );
    }

    function stripOutlookSignature(html) {
      const patterns = [
        /<div class="?MsoNormal"?.*?>/i,
        /--<br\s*\/?>/i,
        /Sent from (my )?iPhone/i
      ];

      for (const p of patterns) {
        const idx = html.search(p);
        if (idx > -1) {
          return html.slice(0, idx).trim();
        }
      }

      return html;
    }

    async function ensureNoOutlookSignature(item) {
      const html = await getBodyHtml(item);

      // CardByte already present ‚Üí do nothing
      if (hasCardByteSignature(html)) return false;

      if (looksLikeOutlookDefaultSignature(html)) {

        const cleaned = stripOutlookSignature(html);

        await item.body.setAsync(cleaned, {
          coercionType: Office.CoercionType.Html
        });

        return true;
      }

      return false;
    }

    window.applySignature = async function (event = { completed: () => { } }) {
      // üõë Prevent parallel or duplicate execution
      if (SIGNATURE_STATE === "loading") {
        event.completed();
        return;
      }

      if (SIGNATURE_STATE === "applied") {
        event.completed();
        return;
      }

      const mailbox = Office.context.mailbox;
      const item = mailbox?.item;
      const user = mailbox.userProfile;

      try {
        if (!item) return;

        // üîê Lock immediately
        SIGNATURE_STATE = "loading";

        const apiResponse = await renderSignatureOnServer(user);
        if (!apiResponse) throw new Error("API failed");

        const { emailSignatureUrl, bannerFileUrl, elements } = apiResponse;

        const finalHtml = generateEmailSignatureHTML(
          emailSignatureUrl === null ? "" : `${emailSignatureUrl}?v=${Date.now()}`,
          elements,
          bannerFileUrl === null ? "" : `${bannerFileUrl}?v=${Date.now()}`,
          !!elements?.find(i => i?.key === "banner")?.link
        );

        await insertSignatureWithoutCursorError(item, finalHtml);

        // ‚úÖ Mark success
        SIGNATURE_STATE = "idle";

      } catch (err) {
        // üîì Unlock on failure (allows retry)
        SIGNATURE_STATE = "idle";

        try {
          const settings = Office.context.roamingSettings;
          const user = mailbox?.userProfile || {};

          const fallbackHtml =
            `
                <table cellpadding="0" cellspacing="0" border="0" width="400">
                    <tr>
                        <td style="font-family:Arial,sans-serif;font-size:12px;">
                            <strong>${user.displayName || ""}</strong><br/>
                            ${user.emailAddress || ""}<br/>
                            <span style="color:#999;">Sent via CardByte</span>
                        </td>
                    </tr>
                </table>
            `.trim();

          await insertAtCursor(item, fallbackHtml);
        } catch (fallbackErr) {
          console.error("‚ùå Failed to apply fallback signature", fallbackErr);
        }
      } finally {
        event.completed();
      }
    };

    function generateEmailSignatureHTML(
      dataURL,
      allFields = [],
      freshLinkForBanner,
      showBanner
    ) {
      const CONTAINER_WIDTH = 600;
      const ICON_SIZE = 25;

      /* ---------- DISCLAIMER ---------- */
      const disclaimerField = allFields.find(
        f => f.key === "disclaimer" && f.show
      );

      /* ---------- SOCIAL LINKS ---------- */
      const socialLinks = allFields
        .filter(i => i?.key?.toLowerCase()?.startsWith("social"))
        .filter(i => i?.show);

      const iconOnlyLinks = socialLinks.filter(i => !i?.label);
      const buttonLinks = socialLinks.filter(i => i?.label);

      /* ---------- SIGNATURE IMAGE ---------- */
      const signatureImageHTML =
        typeof dataURL === "string" && !!dataURL.trim()
          ? `
        <tr>
          <td style="padding-bottom:8px;">
            <img
              src="${dataURL}"
              style="display:block;width:80%;max-width:${CONTAINER_WIDTH}px;height:auto;border:none;border-radius:4px;-ms-interpolation-mode:bicubic;"
              alt="Signature"
            />
          </td>
        </tr>`
          : "";

      /* ---------- ICON ONLY RENDERER ---------- */
      const renderIcon = link => `
    <td
      style="
        padding-right:8px;
        padding-bottom:8px;
      "
    >
      <a
        href="${link.link}"
        style="display:inline-block;text-decoration:none;"
      >
        <img
          src="${link.value}"
          width="${ICON_SIZE}"
          height="${ICON_SIZE}"
          style="display:block;border:0;outline:none;text-decoration:none;"
          alt=""
        />
      </a>
    </td>
    `;


      /* ---------- BUTTON RENDERER ---------- */
      const renderButton = link => `
<td valign="middle" style="padding-right:8px;padding-bottom:8px;">
  <table cellpadding="0" cellspacing="0" border="0">
    <tr>
      <td valign="middle" style="padding-right:6px;">
        <img
          src="${link.value}"
          width="${ICON_SIZE}"
          height="${ICON_SIZE}"
          style="display:block;border:0;"
          alt=""
        />
      </td>
      <td
        valign="middle"
        style="
          font-family:Arial,sans-serif;
          font-size:12px;
          line-height:22px;
          mso-line-height-rule:exactly;
          white-space:nowrap;
          color:#0b2e79ff;
        ">
        <a href="${link.link}" target="_blank"
          style="color:#0b2e79ff;text-decoration:none;">
          ${link.label}
        </a>
      </td>
    </tr>
  </table>
</td>`;

      /* ---------- TOP ROW (icons + max 2 buttons) ---------- */
      const topButtons = buttonLinks.slice(0, 2);
      const remainingButtons = buttonLinks.slice(2);

      const topRowHTML =
        iconOnlyLinks.length || topButtons.length
          ? `
<tr>
  <td style="padding-top:8px;padding-bottom:6px;">
    <table cellpadding="0" cellspacing="0" border="0">
      <tr>
        ${iconOnlyLinks.map(renderIcon).join("")}
        ${topButtons.map(renderButton).join("")}
      </tr>
    </table>
  </td>
</tr>`
          : "";

      /* ---------- REMAINING BUTTON ROWS (2 PER ROW) ---------- */
      const chunkArray = (arr, size) =>
        arr.reduce((acc, _, i) =>
          i % size ? acc : [...acc, arr.slice(i, i + size)], []);

      const buttonRowsHTML = chunkArray(remainingButtons, 2)
        .map(
          row => `
<tr>
  <td style="padding-top:6px;">
    <table cellpadding="0" cellspacing="0" border="0">
      <tr>
        ${row.map(renderButton).join("")}
      </tr>
    </table>
  </td>
</tr>`
        )
        .join("");

      /* ---------- BANNER (SAME AS SIGNATURE) ---------- */
      const bannerHTML =
        typeof freshLinkForBanner === "string" &&
          !!freshLinkForBanner.trim() && freshLinkForBanner !== "null"
          ? `
<tr>
  <td style="padding-top:8px;padding-bottom:8px;">
    <img
      src="${freshLinkForBanner}"
      style="display:block;width:100%;max-width:${CONTAINER_WIDTH}px;height:auto;border:none;border-radius:4px;-ms-interpolation-mode:bicubic;"
      alt="Banner"
    />
  </td>
</tr>`
          : "";
      /* ---------- DISCLAIMER ---------- */
      const disclaimerHTML = disclaimerField
        ? `
<tr>
  <td style="padding-top:8px;">
    <p style="
      margin:0;
      font-size:11px;
      line-height:1.45;
      color:#777;
      font-family:Arial,sans-serif;">
      ${disclaimerField.value.replace(/\n+/g, " ")}
    </p>
  </td>
</tr>`
        : "";

      /* ---------- FINAL HTML (RESPONSIVE) ---------- */
      return `
<table cellpadding="0" cellspacing="0" border="0"
  style="width:100%;max-width:${CONTAINER_WIDTH}px;font-family:Arial,sans-serif;">
  ${signatureImageHTML}
  ${topRowHTML}
  ${buttonRowsHTML}
  ${bannerHTML}
  ${disclaimerHTML}
</table>
`.trim();
    }
    /* ---------------------------------------------------------
           Manual Debug Trigger
           --------------------------------------------------------- */
    window.testCardByte = () =>
      window.applySignature({ completed: () => console.log("üß™ done") });
  </script>
</head>

<body></body>

</html>