<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        Office.onReady(() => {
            console.log("Cardbyte event-based handler ready");
            Office.actions.associate(
                "onNewMessageHandler",
                onNewMessageHandler
            );
        });
        async function onNewMessageHandler(event) {
            try {
                const item = Office.context.mailbox.item;
                if (!item?.body) {
                    event.completed();
                    return;
                }
                // Get signature from your storage or API
                const storedSignature = Office.context.roamingSettings.get("defaultSignatureHtml");
                const signatureHtml = storedSignature || `
                            <div style="font-family: Arial, sans-serif; font-size: 12px; color: #333; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <b>John Doe</b><br/>
                                                    Software Engineer | CardByte<br/>
                                                    üìß <a href="mailto:john@company.com" style="color: #0066cc; text-decoration: none;">john@company.com</a><br/>
                                                    üì± +1 (123) 456-7890<br/>
                                                    üåê <a href="https://cardbyte.ai" style="color: #0066cc; text-decoration: none;">cardbyte.ai</a>
                            </div>
                                                `;
                // Get current body content
                const bodyResult = await new Promise((resolve) => {
                    item.body.getAsync(Office.CoercionType.Html, (result) => {
                        resolve(result);
                    });
                });
                if (bodyResult.status === Office.AsyncResultStatus.Succeeded) {
                    let currentBody = bodyResult.value || "";
                    // Check if signature already exists to avoid duplicates
                    const signatureMarker = "<!--CARDBYTE_SIGNATURE-->";
                    if (!currentBody.includes(signatureMarker)) {
                        // Append signature to the end
                        const newBody = currentBody + signatureMarker + signatureHtml;
                        // Set the new body
                        await new Promise((resolve) => {
                            item.body.setAsync(newBody,
                                { coercionType: Office.CoercionType.Html },
                                (result) => {
                                    console.log("Signature inserted successfully");
                                    resolve(result);
                                }
                            );
                        });
                    } else {
                        console.log("Signature already exists, skipping");
                    }
                }
            } catch (err) {
                console.error("Cardbyte onCompose error", err);
            } finally {
                event.completed(); // ‚úÖ REQUIRED - tells Outlook we're done
            }
        }
    </script>
</head>

<body></body>

</html>