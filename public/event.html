<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>CardByte Event Handler</title>

    <!-- Office.js -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <script>
        /* =========================================================
           CARDBYTE ‚Äì OUTLOOK AUTO-RUN EVENT HANDLER
           ========================================================= */
        const SIGNATURE_SPACER = `
            <br>
            <div style="min-height:50px;">&nbsp;</div>
            <br>
        `;

        const API_URL = "https://newqa-enterprise.cardbyte.ai/email-signature/outlook/get-active";

        const SIGNATURE_MARKER = "<!-- CARDBYTE_SIGNATURE -->";

        // const LOADER_HTML = `
        //         <div id="CARDBYTE_LOADER">
        //         <table cellpadding="0" cellspacing="0" border="0" width="350">
        //             <tr>
        //             <td align="center" style="padding:16px;">
        //                 <span style="font-family:Arial; font-size:12px; color:#666;">
        //                 ‚è≥ Generating your email signature‚Ä¶
        //                 </span>
        //             </td>
        //             </tr>
        //         </table>
        //         </div>
        //         `;
        const LOADER_HTML = `
                <!-- CARDBYTE_LOADER_START -->
                <table cellpadding="0" cellspacing="0" border="0" width="350">
                <tr>
                    <td align="center" style="padding:16px;">
                    <span style="font-family:Arial; font-size:12px; color:#666;">
                        ‚è≥ Generating your email signature‚Ä¶
                    </span>
                    </td>
                </tr>
                </table>
                <!-- CARDBYTE_LOADER_END -->
                `;


        /* ---------------------------------------------------------
           Office Ready
           --------------------------------------------------------- */
        async function replaceSignature(item, html) {
            return new Promise((resolve, reject) => {
                item.body.getAsync(Office.CoercionType.Html, r => {
                    if (r.status !== "succeeded") return reject(r.error);

                    const updated = r.value.replace(
                        /<!-- CARDBYTE_LOADER_START -->[\s\S]*?<!-- CARDBYTE_LOADER_END -->/,
                        html
                    );

                    item.body.setAsync(
                        updated,
                        { coercionType: Office.CoercionType.Html },
                        s => (s.status === "succeeded" ? resolve() : reject(s.error))
                    );
                });
            });
        }

        Office.onReady(async () => {
            console.log("‚úÖ CardByte event.html ready");
            // const user = {
            //     displayName: "Sairajesh Korla",
            //     emailAddress:
            //         // "riya00907@outlook.com"
            //         // "Muskanrai@cardbyte.ai"
            //         // "sairajesh.korla1272@outlook.com"
            //         "sairajeshkorla@gamil.com"
            // };
            // try {
            //     const apiResponse = await renderSignatureOnServer(user)
            //     const { emailSignatureUrl, bannerFileUrl, elements } = apiResponse
            //     const freshLink = `${emailSignatureUrl}?v=${Date.now()}`

            //     const freshLinkForBanner = `${bannerFileUrl}?v=${Date.now()}`

            //     const html = generateEmailSignatureHTML(
            //         freshLink,
            //         elements,
            //         freshLinkForBanner,
            //         !!elements?.find(i => i?.key === "banner")?.link
            //     );
            //     console.log("üì¶ Signature API response", html);
            // } catch (e) {
            //     const signatureHtml =
            //         SIGNATURE_MARKER +
            //         `
            //     <div style="font-family:Arial;font-size:12px">
            //             <strong>${user.displayName}</strong><br/>
            //             ${user.emailAddress}<br/>
            //             <span style="color:#999">Sent via CardByte</span>
            //             </div>
            //             `;
            //     console.log("sdkjhadkhsad", e, signatureHtml)
            // }
        });

        async function renderSignatureOnServer(user) {
            try {

                const res = await fetch("https://qa-renderer.cardbyte.ai/render-signature", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ email: user.emailAddress })
                });
                if (!res.ok) {
                    throw new Error("Node renderer failed");
                }
                const data = await res?.json()
                return data; // optional
            } catch (e) {
                console.error("error", e)
                return null;
            }
        }

        /* ---------------------------------------------------------
           Signature Helpers
           --------------------------------------------------------- */
        function insertAtCursor(item, html) {
            return new Promise((resolve, reject) => {
                item.body.setSelectedDataAsync(
                    SIGNATURE_SPACER + html,
                    { coercionType: Office.CoercionType.Html },
                    r => (r.status === "succeeded" ? resolve() : reject(r.error))
                );
            });
        }

        function appendSignature(item, html) {
            return new Promise((resolve, reject) => {
                item.body.getAsync(
                    Office.CoercionType.Html,
                    r => {
                        if (r.status !== "succeeded") {
                            reject(r.error);
                            return;
                        }

                        if (r.value.includes(SIGNATURE_MARKER)) {
                            console.log("üìå Signature already present");
                            resolve();
                            return;
                        }

                        const updated =
                            r.value +
                            SIGNATURE_SPACER +
                            SIGNATURE_MARKER +
                            html;

                        item.body.setAsync(
                            updated,
                            { coercionType: Office.CoercionType.Html },
                            s => (s.status === "succeeded" ? resolve() : reject(s.error))
                        );
                    }
                );
            });
        }


        /* ---------------------------------------------------------
           AUTO-RUN ENTRY POINT (MUST BE GLOBAL)
           --------------------------------------------------------- */
        // window.applySignature = async function (event) {
        //     console.log("üöÄ applySignature triggered");

        //     try {
        //         const mailbox = Office.context.mailbox;
        //         const item = mailbox?.item;
        //         if (!item) return;

        //         const user = mailbox.userProfile;
        //         const apiResponse = await renderSignatureOnServer(user)
        //         const { emailSignatureUrl, bannerFileUrl, elements } = apiResponse
        //         console.log("üì¶ Signature API response", apiResponse);
        //         const freshLink = `${emailSignatureUrl}?v=${Date.now()}`

        //         const freshLinkForBanner = `${bannerFileUrl}?v=${Date.now()}`

        //         const html = generateEmailSignatureHTML(
        //             freshLink,
        //             elements,
        //             freshLinkForBanner,
        //             !!elements?.find(i => i?.key === "banner")?.link
        //         );
        //         const settings = Office.context.roamingSettings;

        //         const signatureHtml =
        //             html || settings.get("defaultSignatureHtml") ||
        //             `
        //                 <div style="font-family:Arial;font-size:12px">
        //                     <strong>${user.displayName}</strong><br/>
        //                     ${user.emailAddress}<br/>
        //                     <span style="color:#999">Sent with CardByte</span>
        //                 </div>
        //             `;

        //         try {
        //             await insertAtCursor(item, signatureHtml);
        //         } catch {
        //             await appendSignature(item, signatureHtml);
        //         }

        //         console.log("‚úÖ Signature applied");
        //     } catch (err) {
        //         console.error("‚ùå applySignature error", err);
        //     } finally {
        //         event.completed();
        //     }
        // };



        window.applySignature = async function (event) {
            console.log("üöÄ applySignature triggered");

            const mailbox = Office.context.mailbox;
            const item = mailbox?.item;

            try {
                if (!item) return;

                // üîπ STEP 1: Insert loader immediately
                await insertAtCursor(item, SIGNATURE_MARKER + LOADER_HTML);

                // üîπ STEP 2: Call API
                const user = mailbox.userProfile;
                const apiResponse = await renderSignatureOnServer(user);
                if (!apiResponse) throw new Error("API failed");

                const { emailSignatureUrl, bannerFileUrl, elements } = apiResponse;

                const finalHtml = generateEmailSignatureHTML(
                    `${emailSignatureUrl}?v=${Date.now()}`,
                    elements,
                    `${bannerFileUrl}?v=${Date.now()}`,
                    !!elements?.find(i => i?.key === "banner")?.link
                );

                // üîπ STEP 3: Replace loader with final signature
                await replaceSignature(item, finalHtml);

                console.log("‚úÖ Signature applied");
            } catch (err) {
                console.error("‚ùå applySignature error", err);

                try {
                    const settings = Office.context.roamingSettings;
                    const user = mailbox?.userProfile || {};

                    const fallbackHtml =
                        settings.get("defaultSignatureHtml") ||
                        `
                            <table cellpadding="0" cellspacing="0" border="0" width="350">
                            <tr>
                                <td style="font-family:Arial,sans-serif;font-size:12px;">
                                <strong>${user.displayName || ""}</strong><br/>
                                ${user.emailAddress || ""}<br/>
                                <span style="color:#999;">Sent via CardByte</span>
                                </td>
                            </tr>
                            </table>
                        `.trim();

                    // üîÅ Replace loader with fallback signature
                    await replaceSignature(item, fallbackHtml);
                } catch (fallbackErr) {
                    console.error("‚ùå Failed to apply fallback signature", fallbackErr);
                }
            } finally {
                event.completed();
            }
        };


        function generateEmailSignatureHTML(
            dataURL,
            allFields = [],
            freshLinkForBanner,
            showBanner
        ) {
            const disclaimerField = allFields.find(
                f => f.key === "disclaimer" && f.show
            );

            const normalLinks = allFields
                .filter(i => i?.key?.toLowerCase()?.startsWith("social"))
                .filter(i => !["teams", "meet", "calendly", "pdf", "url"].includes(i?.name))
                .filter(i => i?.show);

            const buttonLinks = allFields
                .filter(i => i?.key?.toLowerCase()?.startsWith("social"))
                .filter(i => ["teams", "meet", "calendly", "pdf", "url"].includes(i?.name))
                .filter(i => i?.show);

            /* ---------- MAIN SIGNATURE CARD (350px) ---------- */
            const signatureImageHTML =
                typeof dataURL === "string" && dataURL.trim()
                    ? `
<tr>
  <td style="padding-bottom:8px;">
    <img
      src="${dataURL}"
      alt="Signature"
      width="350"
      style="
        display:block;
        width:350px;
        height:auto;
        border:1px solid #ddd;
        border-radius:8px;
      "
    />
  </td>
</tr>`
                    : "";

            /* ---------- SOCIAL ICONS + CTA BUTTONS ---------- */
            const combinedLinks = [...normalLinks, ...buttonLinks];

            const combinedLinksHTML = combinedLinks.length
                ? `
<tr>
  <td style="padding-top:8px;">
    ${combinedLinks
                    .map(link => {
                        const isButton = ["teams", "meet", "calendly", "pdf", "url"].includes(
                            link?.name
                        );

                        return `
<table role="presentation" cellpadding="0" cellspacing="0" border="0"
  style="display:inline-table;margin-right:8px;margin-bottom:8px;">
  <tr>
    <td valign="middle">
      ${isButton
                                ? `
<a href="${link?.link}" target="_blank"
  style="
    display:inline-block;
    padding:8px 18px;
    border:1px solid #000;
    border-radius:22px;
    font-size:13px;
    font-family:Arial, sans-serif;
    color:#000;
    text-decoration:none;
    white-space:nowrap;
  ">
  ${link?.value
                                    ? `<img src="${link.value}" width="16" style="vertical-align:middle;margin-right:6px;" />`
                                    : ""
                                }
  ${link?.label || link?.name}
</a>`
                                : `
<a href="${link?.link}" target="_blank">
  <img src="${link.value}" width="22" height="22" style="display:block;border:0;" />
</a>`
                            }
    </td>
  </tr>
</table>`;
                    })
                    .join("")}
  </td>
</tr>`
                : "";

            /* ---------- BANNER (350px LOCKED) ---------- */
            const bannerHTML =
                typeof freshLinkForBanner === "string" &&
                    freshLinkForBanner.trim() &&
                    showBanner
                    ? `
<tr>
  <td style="padding-top:8px;">
    <!--[if mso]>
    <table width="350" cellpadding="0" cellspacing="0" border="0"><tr><td>
    <![endif]-->

    <img
      src="${freshLinkForBanner}"
      alt=""
      width="350"
      height="110"
      style="
        display:block;
        width:350px;
        height:110px;
        border:0;
      "
    />

    <!--[if mso]></td></tr></table><![endif]-->
  </td>
</tr>`
                    : "";

            /* ---------- DISCLAIMER ---------- */
            const disclaimerHTML = disclaimerField
                ? `
<tr>
  <td style="padding-top:8px;">
    <p style="
      margin:0;
      font-size:11px;
      line-height:1.45;
      color:#777;
      font-family:Arial, sans-serif;">
      ${disclaimerField.value.replace(/\n+/g, " ")}
    </p>
  </td>
</tr>`
                : "";

            /* ---------- FINAL WRAPPER (HARD WIDTH) ---------- */
            return `
<table
  cellpadding="0"
  cellspacing="0"
  border="0"
  width="350"
  style="
    width:350px;
    font-family:Arial, sans-serif;
  "
>
  ${signatureImageHTML}
  ${combinedLinksHTML}
  ${bannerHTML}
  ${disclaimerHTML}
</table>
`.trim();
        }

        /* ---------------------------------------------------------
           Manual Debug Trigger
           --------------------------------------------------------- */
        window.testCardByte = () =>
            window.applySignature({ completed: () => console.log("üß™ done") });
    </script>
</head>

<body></body>

</html>