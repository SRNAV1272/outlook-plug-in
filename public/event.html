<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>CardByte Outlook Event</title>

  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <script>
    /* =========================================================
       CARDBYTE ‚Äì OUTLOOK AUTO-RUN EVENT (PRODUCTION SAFE)
       ========================================================= */

    let RUNNING = false;

    const SIG_START = "<!-- CARD_BYTE_SIGNATURE_START -->";
    const SIG_END = "<!-- CARD_BYTE_SIGNATURE_END -->";

    /* ---------------------------------------------------------
       OFFICE READY
    --------------------------------------------------------- */
    Office.onReady(() => {
      console.log("‚úÖ CardByte event.html ready");
      applySignature({ completed() { } });
    });

    /* ---------------------------------------------------------
       FETCH SIGNATURE (CID BASED)
    --------------------------------------------------------- */
    async function fetchSignature(user) {
      const res = await fetch(
        "https://qa-renderer.cardbyte.ai/render-signature-cid",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: user.emailAddress })
        }
      );

      if (!res.ok) throw new Error("Signature API failed");
      return res.json(); // { html, attachments }
    }

    /* ---------------------------------------------------------
       BODY HELPERS
    --------------------------------------------------------- */
    function getBodyHtml(item) {
      return new Promise((resolve, reject) => {
        item.body.getAsync(Office.CoercionType.Html, r =>
          r.status === "succeeded" ? resolve(r.value || "") : reject(r.error)
        );
      });
    }

    function stripOldSignature(html) {
      return html.replace(
        /<!-- CARD_BYTE_SIGNATURE_START -->[\s\S]*?<!-- CARD_BYTE_SIGNATURE_END -->/gi,
        ""
      ).trim();
    }

    function setBodyHtml(item, html) {
      return new Promise((resolve, reject) => {
        item.body.setAsync(
          html,
          { coercionType: Office.CoercionType.Html },
          r => (r.status === "succeeded" ? resolve() : reject(r.error))
        );
      });
    }

    /* ---------------------------------------------------------
       ATTACH CID IMAGES
    --------------------------------------------------------- */
    async function attachCidImages(item, attachments = []) {
      for (const img of attachments) {
        console.log("üîÑ Attaching CID image:", img.cid, img?.filename);
        await new Promise((resolve, reject) => {
          console.log("üîÑ Attaching CID image: inside promise", img.cid, img?.filename);
          item.addFileAttachmentFromBase64Async(
            img.base64,
            img.filename,
            {
              isInline: true,
              contentId: img.cid
            },
            r => (r.status === "succeeded" ? resolve() : reject(r.error))
          );
        });
      }
    }

    /* ---------------------------------------------------------
       APPLY SIGNATURE (HARD REPLACE ‚Äì SAFE)
    --------------------------------------------------------- */
    async function applySignature(event = { completed() { } }) {
      if (RUNNING) {
        event.completed();
        return;
      }

      RUNNING = true;

      try {
        const mailbox = Office.context.mailbox;
        const item = mailbox?.item;
        const user = mailbox?.userProfile;

        if (!item) return;

        // 1Ô∏è‚É£ Get payload from server
        const payload = await fetchSignature(user);
        if (!payload?.html) throw new Error("Invalid payload");

        console.log("‚úÖ Signature payload fetched");

        // 2Ô∏è‚É£ Attach CID images FIRST
        await attachCidImages(item, payload.attachments || []);

        // 3Ô∏è‚É£ Read current body
        const current = await getBodyHtml(item);
        const cleaned = stripOldSignature(current);

        // 4Ô∏è‚É£ Append signature
        const finalHtml = `
            ${cleaned}
            <br/><br/>
            ${SIG_START}
            ${payload.html}
            ${SIG_END}
        `.trim();

        // 5Ô∏è‚É£ Single write (STABLE)
        await setBodyHtml(item, finalHtml);

        console.log("‚úÖ Signature applied successfully");

      } catch (err) {
        console.error("‚ùå Signature failed", err);
      } finally {
        RUNNING = false;
        event.completed();
      }
    }

    window.applySignature = applySignature;
  </script>
</head>

<body></body>

</html>