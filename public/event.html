<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>CardByte Event Handler</title>

    <!-- Office.js -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <script>
        /* =========================================================
           CARDBYTE ‚Äì OUTLOOK AUTO-RUN EVENT HANDLER
           ========================================================= */
        const SIGNATURE_SPACER = `
            <br><br>
            <div style="min-height:80px;">&nbsp;</div>
            <br>
        `;

        const API_URL =
            "https://newqa-enterprise.cardbyte.ai/email-signature/outlook/get-active";

        const SIGNATURE_MARKER = "<!-- CARDBYTE_SIGNATURE -->";

        /* ---------------------------------------------------------
           Office Ready
           --------------------------------------------------------- */
        Office.onReady(async () => {
            console.log("‚úÖ CardByte event.html ready");

            try {
                const mailbox = Office.context.mailbox;
                const item = mailbox?.item;
                // if (!item) return;
                const user = {
                    emailAddress:
                        "riya00907@outlook.com"
                        // "Muskanrai@cardbyte.ai"
                    // "sairajesh.korla1272@outlook.com"
                };

                const apiResponse = await renderSignatureOnServer(user)
                const { emailSignatureUrl, bannerFileUrl, elements } = apiResponse
                const freshLink = `${emailSignatureUrl}?v=${Date.now()}`

                const freshLinkForBanner = `${bannerFileUrl}?v=${Date.now()}`

                const html = generateEmailSignatureHTML(
                    freshLink,
                    elements,
                    freshLinkForBanner,
                    !!elements?.find(i => i?.key === "banner")?.link
                );

                // // const settings = Office.context.roamingSettings;
                // // settings.set("defaultSignatureHtml", html)
                // // settings.saveAsync((result) => {
                // //     if (result.status === Office.AsyncResultStatus.Succeeded) {
                // //         console.log("‚úÖ Signature saved");
                // //     } else {
                // //         console.error("‚ùå Failed to save", result.error);
                // //     }
                // // });
                // apply(html)
                console.log("üì¶ Signature API response", html);
            } catch (e) {
                console.error("‚ùå Association failed", e);
                const settings = Office.context.roamingSettings;

                const signatureHtml =
                    settings.get("defaultSignatureHtml") ||
                    `
                        <div style="font-family:Arial;font-size:12px">
                            <strong>${user.displayName}</strong><br/>
                            ${user.emailAddress}<br/>
                            <span style="color:#999">Sent with CardByte</span>
                        </div>
                    `;

                try {
                    await insertAtCursor(item, signatureHtml);
                } catch {
                    await appendSignature(item, signatureHtml);
                }
            }
        });

        async function renderSignatureOnServer(user) {
            const res = await fetch("https://qa-renderer.cardbyte.ai/render-signature", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ email: user.emailAddress })
            });
            // console.log("adjahsdkhsad", data)
            if (!res.ok) {
                throw new Error("Node renderer failed");
            }
            const data = await res?.json()
            console.log("sdajsdkjhsdkjsad", data)
            // const blob = await res.blob();

            // // ‚úÖ Create downloadable URL
            // const url = URL.createObjectURL(blob);

            // // ‚úÖ Trigger download
            // const a = document.createElement("a");
            // a.href = url;
            // a.download = "signature.png"; // üëà filename
            // document.body.appendChild(a);
            // a.click();

            // // ‚úÖ Cleanup
            // document.body.removeChild(a);
            // URL.revokeObjectURL(url);

            return data; // optional
        }

        /* ---------------------------------------------------------
           Signature Helpers
           --------------------------------------------------------- */
        function insertAtCursor(item, html) {
            return new Promise((resolve, reject) => {
                item.body.setSelectedDataAsync(
                    SIGNATURE_SPACER + SIGNATURE_MARKER + html,
                    { coercionType: Office.CoercionType.Html },
                    r => (r.status === "succeeded" ? resolve() : reject(r.error))
                );
            });
        }

        function appendSignature(item, html) {
            return new Promise((resolve, reject) => {
                item.body.getAsync(
                    Office.CoercionType.Html,
                    r => {
                        if (r.status !== "succeeded") {
                            reject(r.error);
                            return;
                        }

                        if (r.value.includes(SIGNATURE_MARKER)) {
                            console.log("üìå Signature already present");
                            resolve();
                            return;
                        }

                        const updated =
                            r.value +
                            SIGNATURE_SPACER +
                            SIGNATURE_MARKER +
                            html;

                        item.body.setAsync(
                            updated,
                            { coercionType: Office.CoercionType.Html },
                            s => (s.status === "succeeded" ? resolve() : reject(s.error))
                        );
                    }
                );
            });
        }


        /* ---------------------------------------------------------
           AUTO-RUN ENTRY POINT (MUST BE GLOBAL)
           --------------------------------------------------------- */
        window.applySignature = async function (event) {
            console.log("üöÄ applySignature triggered");

            try {
                const mailbox = Office.context.mailbox;
                const item = mailbox?.item;
                if (!item) return;

                const user = mailbox.userProfile;
                const apiResponse = await renderSignatureOnServer(user)
                const { emailSignatureUrl, bannerFileUrl, elements } = apiResponse
                console.log("üì¶ Signature API response", apiResponse);
                const freshLink = `${emailSignatureUrl}?v=${Date.now()}`

                const freshLinkForBanner = `${bannerFileUrl}?v=${Date.now()}`

                const html = generateEmailSignatureHTML(
                    freshLink,
                    elements,
                    freshLinkForBanner,
                    !!elements?.find(i => i?.key === "banner")?.link
                );
                const settings = Office.context.roamingSettings;

                const signatureHtml =
                    html || settings.get("defaultSignatureHtml") ||
                    `
                        <div style="font-family:Arial;font-size:12px">
                            <strong>${user.displayName}</strong><br/>
                            ${user.emailAddress}<br/>
                            <span style="color:#999">Sent with CardByte</span>
                        </div>
                    `;

                try {
                    await insertAtCursor(item, signatureHtml);
                } catch {
                    await appendSignature(item, signatureHtml);
                }

                console.log("‚úÖ Signature applied");
            } catch (err) {
                console.error("‚ùå applySignature error", err);
            } finally {
                event.completed();
            }
        };

        function generateEmailSignatureHTML(
            dataURL,
            allFields = [],
            freshLinkForBanner,
            showBanner
        ) {
            const disclaimerField = allFields.find(
                f => f.key === "disclaimer" && f.show
            );

            const normalLinks = allFields
                .filter(i => i?.key?.toLowerCase()?.startsWith("social"))
                .filter(i => !["teams", "meet", "calendly", "pdf", "url"].includes(i?.name))
                .filter(i => i?.show);

            const buttonLinks = allFields
                .filter(i => i?.key?.toLowerCase()?.startsWith("social"))
                .filter(i => ["teams", "meet", "calendly", "pdf", "url"].includes(i?.name))
                .filter(i => i?.show);

            /* ---------- MAIN SIGNATURE CARD (350px) ---------- */
            const signatureImageHTML =
                typeof dataURL === "string" && dataURL.trim()
                    ? `
<tr>
  <td style="padding-bottom:8px;">
    <img
      src="${dataURL}"
      alt="Signature"
      width="350"
      style="
        display:block;
        width:350px;
        height:auto;
        border:1px solid #ddd;
        border-radius:8px;
      "
    />
  </td>
</tr>`
                    : "";

            /* ---------- SOCIAL ICONS + CTA BUTTONS ---------- */
            const combinedLinks = [...normalLinks, ...buttonLinks];

            const combinedLinksHTML = combinedLinks.length
                ? `
<tr>
  <td style="padding-top:8px;">
    ${combinedLinks
                    .map(link => {
                        const isButton = ["teams", "meet", "calendly", "pdf", "url"].includes(
                            link?.name
                        );

                        return `
<table role="presentation" cellpadding="0" cellspacing="0" border="0"
  style="display:inline-table;margin-right:8px;margin-bottom:8px;">
  <tr>
    <td valign="middle">
      ${isButton
                                ? `
<a href="${link?.link}" target="_blank"
  style="
    display:inline-block;
    padding:8px 18px;
    border:1px solid #000;
    border-radius:22px;
    font-size:13px;
    font-family:Arial, sans-serif;
    color:#000;
    text-decoration:none;
    white-space:nowrap;
  ">
  ${link?.value
                                    ? `<img src="${link.value}" width="16" style="vertical-align:middle;margin-right:6px;" />`
                                    : ""
                                }
  ${link?.label || link?.name}
</a>`
                                : `
<a href="${link?.link}" target="_blank">
  <img src="${link.value}" width="22" height="22" style="display:block;border:0;" />
</a>`
                            }
    </td>
  </tr>
</table>`;
                    })
                    .join("")}
  </td>
</tr>`
                : "";

            /* ---------- BANNER (350px LOCKED) ---------- */
            const bannerHTML =
                typeof freshLinkForBanner === "string" &&
                    freshLinkForBanner.trim() &&
                    showBanner
                    ? `
<tr>
  <td style="padding-top:8px;">
    <!--[if mso]>
    <table width="350" cellpadding="0" cellspacing="0" border="0"><tr><td>
    <![endif]-->

    <img
      src="${freshLinkForBanner}"
      alt=""
      width="350"
      height="110"
      style="
        display:block;
        width:350px;
        height:110px;
        border:0;
      "
    />

    <!--[if mso]></td></tr></table><![endif]-->
  </td>
</tr>`
                    : "";

            /* ---------- DISCLAIMER ---------- */
            const disclaimerHTML = disclaimerField
                ? `
<tr>
  <td style="padding-top:8px;">
    <p style="
      margin:0;
      font-size:11px;
      line-height:1.45;
      color:#777;
      font-family:Arial, sans-serif;">
      ${disclaimerField.value.replace(/\n+/g, " ")}
    </p>
  </td>
</tr>`
                : "";

            /* ---------- FINAL WRAPPER (HARD WIDTH) ---------- */
            return `
<table
  cellpadding="0"
  cellspacing="0"
  border="0"
  width="350"
  style="
    width:350px;
    font-family:Arial, sans-serif;
  "
>
  ${signatureImageHTML}
  ${combinedLinksHTML}
  ${bannerHTML}
  ${disclaimerHTML}
</table>
`.trim();
        }

        /* ---------------------------------------------------------
           Manual Debug Trigger
           --------------------------------------------------------- */
        window.testCardByte = () =>
            window.applySignature({ completed: () => console.log("üß™ done") });
    </script>
</head>

<body></body>

</html>